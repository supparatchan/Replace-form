<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏ö‡∏¥‡∏Å Kit ‡∏ó‡∏î‡πÅ‡∏ó‡∏ô - PharmaKit</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500&display=swap" rel="stylesheet">
    <style>
        body { background-color: #F0F4F3; font-family: 'Kanit', sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: none; }
        .pastel-header { background-color: #015958; color: white; border-radius: 15px 15px 0 0; padding: 15px; text-align: center; }
        .label { color: #4A4A4A; font-weight: 500; }
        .button.is-primary { background-color: #015958; color: #ffffff; border: none; font-weight: bold; }
        .button.is-primary:hover { background-color: #014140; }
        .input-prefix { background-color: #E0E0E0; border-radius: 8px 0 0 8px; padding: 7px 15px; font-weight: bold; display: flex; align-items: center; }
        .input-main { border-radius: 0 8px 8px 0 !important; }
        .drug-results { border: 1px solid #ddd; border-top: none; max-height: 150px; overflow-y: auto; display: none; background: white; position: absolute; width: 100%; z-index: 10; }
        .drug-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .drug-item:hover { background-color: #F5F5F5; }
        .grade-container { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .grade-item { background-color: #ffffff; border: 2px solid #E0E0E0; border-radius: 12px; padding: 12px 20px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #666; }
        .grade-item.active { background-color: #015958 !important; color: #ffffff !important; border-color: #015958; transform: scale(1.02); }
        .grade-badge { background-color: #f0f0f0; border-radius: 50%; width: 28px; height: 28px; display: flex; justify-content: center; align-items: center; font-size: 0.8rem; color: #333; }
        .active .grade-badge { background-color: rgba(255, 255, 255, 0.2); color: white; }
    </style>
</head>
<body>
    <section class="section">
        <div class="container">
            <div class="card">
                <div class="pastel-header">
                    <h1 class="title is-5 has-text-white">üìã ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å Kit ‡∏ó‡∏î‡πÅ‡∏ó‡∏ô</h1>
                </div>
                <div class="card-content">
                    <div class="field">
                        <label class="label">‡∏£‡∏´‡∏±‡∏™ Kit ID ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ (‡πÄ‡∏•‡∏Ç 3 ‡∏´‡∏•‡∏±‡∏Å)</label>
                        <div class="field has-addons">
                            <div class="control"><span class="input-prefix">EX-</span></div>
                            <div class="control is-expanded">
                                <input class="input input-main" type="number" id="kitNum" placeholder="‡πÄ‡∏ä‡πà‡∏ô 001" oninput="checkKitID(this.value)">
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                        <div class="control">
                            <input class="input" type="text" id="wardName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Kit ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏≠‡∏£‡πå‡∏î..." readonly onclick="enableWardEdit()">
                        </div>
                        <p class="help is-info" id="wardStatus">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏≠‡∏£‡πå‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏Ç Kit ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                    </div>

                    <hr>

                    <div class="field" style="position: relative;">
                        <label class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î Extravasation</label>
                        <div class="control">
                            <input class="input" type="text" id="drugInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤..." oninput="smartSearchDrug(this.value)">
                        </div>
                        <div id="drugResults" class="drug-results"></div>
                    </div>

                    <div class="field">
                        <label class="label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏≤</label>
                        <div class="control"><div class="select is-fullwidth"><select id="position"><option value="‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠">‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠ (Dorsum of hand)</option><option value="‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠">‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠ (Wrist)</option><option value="‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Ç‡∏ô">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Ç‡∏ô (Forearm)</option><option value="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô</option></select></div></div>
                    </div>

                    <div class="field">
                        <label class="label">‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (Grade)</label>
                        <div class="grade-container">
                            <div class="grade-item" onclick="setGrade(0)" id="g0"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 0: No symptoms</span><span class="grade-badge">0</span></div>
                            <div class="grade-item" onclick="setGrade(1)" id="g1"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 1: Mild symptoms</span><span class="grade-badge">1</span></div>
                            <div class="grade-item" onclick="setGrade(2)" id="g2"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 2: Moderate symptoms</span><span class="grade-badge">2</span></div>
                            <div class="grade-item" onclick="setGrade(3)" id="g3"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 3: Severe symptoms</span><span class="grade-badge">3</span></div>
                            <div class="grade-item" onclick="setGrade(4)" id="g4"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 4: Life-threatening</span><span class="grade-badge">4</span></div>
                        </div>
                        <input type="hidden" id="grade" value="">
                    </div>

                    <button class="button is-primary is-fullwidth is-large mt-5" id="submitBtn" onclick="submitReplacement()">
                        üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å Kit
                    </button>
                </div>
            </div>
        </div>
    </section>

    <script>
        const drugList = [
            { name: "Vinblastine", keys: "vbl velbe" }, { name: "Vinorelbine", keys: "vnr navelbine" },
            { name: "Oxaliplatin", keys: "oxa eloxatin" }, { name: "Carmustine", keys: "bcnu bicnu" },
            { name: "Docetaxel", keys: "taxotere" }, { name: "Paclitaxel", keys: "tax taxol" },
            { name: "Dactinomycin", keys: "actd cosmegen" }, { name: "Doxorubicin", keys: "adr adriamycin" },
            { name: "Idarubicin", keys: "ida idamycin" }, { name: "Mitomycin", keys: "mmc mitomycin-c" },
            { name: "Mitoxantrone", keys: "novantrone" }, { name: "Bendamustine", keys: "treanda" },
            { name: "Bleomycin", keys: "bleo" }, { name: "Busulfan", keys: "myleran" },
            { name: "Carboplatin", keys: "cbdca" }, { name: "Carfilzomib", keys: "kyprolis" },
            { name: "Cisplatin", keys: "cddp" }, { name: "Cyclophosphamide", keys: "ctx cyc" },
            { name: "Dacarbazine", keys: "dtic" }, { name: "Etoposide", keys: "vp-16" },
            { name: "Fluorouracil", keys: "5fu 5-fu" }, { name: "Gemcitabine", keys: "gemzar" },
            { name: "Ifosfamide", keys: "ifo" }, { name: "Irinotecan", keys: "cpt-11 camptosar" },
            { name: "Melphalan", keys: "alkeran" }, { name: "Topotecan", keys: "hycamtin" },
            { name: "Cytarabine", keys: "ara-c" }, { name: "Fludarabine", keys: "fludara" },
            { name: "Methotrexate", keys: "mtx" }, { name: "Pemetrexed", keys: "alimta" },
            { name: "Asparaginase", keys: "elspar" }, { name: "Bortezomib", keys: "btz velcade" },
            { name: "Arsenic trioxide", keys: "ato" }, { name: "Cabazitaxel", keys: "jevtana" }
        ];

        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyCE7cYQuZaOWBd_Pd36nEid2Zts259j-8r-cPtbX3EtbofLuZjmK4JaG8BQjYyJTdg/exec"; 
        let kitInventory = [];

        async function init() {
            try {
                await liff.init({ liffId: "2009181600-gwOEGw9p" }); 
                if (!liff.isLoggedIn()) liff.login();
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏≠‡∏£‡πå‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å GAS
                const response = await fetch(`${GAS_API_URL}?action=getInventory`);
                kitInventory = await response.json();
                console.log("Data Loaded Ready");
            } catch (err) { console.error("Init Error", err); }
        }
        init();

        // üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏≠‡∏£‡πå‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Sheet
        function checkKitID(val) {
            const wardInput = document.getElementById('wardName');
            const statusLabel = document.getElementById('wardStatus');
            
            if (val.length === 3) {
                const fullId = "EX-" + val;
                wardInput.value = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
                
                const match = kitInventory.find(item => item.kitId === fullId);
                
                if (match && match.ward) {
                    wardInput.value = match.ward;
                    wardInput.readOnly = true;
                    statusLabel.innerText = "‚úÖ ‡∏û‡∏ö‡∏ß‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á Kit";
                } else {
                    wardInput.value = "";
                    wardInput.readOnly = false;
                    wardInput.placeholder = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏≠‡∏£‡πå‡∏î...";
                    statusLabel.innerText = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö Kit ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)";
                    wardInput.focus();
                }
            }
        }

        function enableWardEdit() {
            const wardInput = document.getElementById('wardName');
            wardInput.readOnly = false;
            wardInput.placeholder = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏≠‡∏£‡πå‡∏î...";
        }

        function smartSearchDrug(val) {
            const resDiv = document.getElementById('drugResults');
            const searchVal = val.toLowerCase().trim();
            if (searchVal.length >= 3) {
                const filtered = drugList.filter(item => item.name.toLowerCase().includes(searchVal) || item.keys.toLowerCase().includes(searchVal));
                resDiv.innerHTML = filtered.map(item => `<div class="drug-item" onclick="selectDrug('${item.name}')"><strong>${item.name}</strong><br><small>Keywords: ${item.keys}</small></div>`).join('');
                resDiv.style.display = filtered.length ? 'block' : 'none';
            } else { resDiv.style.display = 'none'; }
        }

        function selectDrug(name) {
            document.getElementById('drugInput').value = name;
            document.getElementById('drugResults').style.display = 'none';
        }

        function setGrade(g) {
            document.getElementById('grade').value = g;
            document.querySelectorAll('.grade-item').forEach(item => item.classList.remove('active'));
            document.getElementById('g' + g).classList.add('active');
        }

        async function submitReplacement() {
            const submitBtn = document.getElementById('submitBtn');
            const data = {
                kitId: "EX-" + document.getElementById('kitNum').value,
                ward: document.getElementById('wardName').value,
                drug: document.getElementById('drugInput').value,
                pos: document.getElementById('position').value,
                grade: document.getElementById('grade').value
            };

            if (!document.getElementById('kitNum').value || !data.drug || data.grade === "") {
                alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return;
            }

            submitBtn.disabled = true;
            submitBtn.classList.add('is-loading');
            submitBtn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

            try {
                const msg = `REQ_REPLACEMENT|${data.kitId}|${data.ward}|${data.drug}|${data.pos}|${data.grade}`;
                await liff.sendMessages([{ "type": "text", "text": msg }]);
                liff.closeWindow();
            } catch (err) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('is-loading');
                submitBtn.innerText = "üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å Kit";
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            }
        }
    </script>
</body>
</html>
