<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏ö‡∏¥‡∏Å Kit ‡∏ó‡∏î‡πÅ‡∏ó‡∏ô - PharmaKit</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500&display=swap" rel="stylesheet">
    <style>
        body { background-color: #F0F4F3; font-family: 'Kanit', sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: none; }
        .pastel-header { background-color: #015958; color: white; border-radius: 15px 15px 0 0; padding: 15px; text-align: center; }
        .label { color: #4A4A4A; font-weight: 500; }
        .button.is-primary { background-color: #015958; color: #ffffff; border: none; font-weight: bold; }
        .button.is-primary:hover { background-color: #014140; }
        .input-prefix { background-color: #E0E0E0; border-radius: 8px 0 0 8px; padding: 7px 15px; font-weight: bold; display: flex; align-items: center; }
        .input-main { border-radius: 0 8px 8px 0 !important; }
        .drug-results { border: 1px solid #ddd; border-top: none; max-height: 150px; overflow-y: auto; display: none; background: white; position: absolute; width: 100%; z-index: 10; }
        .drug-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .drug-item:hover { background-color: #F5F5F5; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå Grade Cards */
        .grade-container { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .grade-item { background-color: #ffffff; border: 2px solid #E0E0E0; border-radius: 12px; padding: 12px 20px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #666; }
        .grade-item.active { background-color: #015958 !important; color: #ffffff !important; border-color: #015958; transform: scale(1.02); }
        .grade-badge { background-color: #f0f0f0; border-radius: 50%; width: 28px; height: 28px; display: flex; justify-content: center; align-items: center; font-size: 0.8rem; color: #333; }
        .active .grade-badge { background-color: rgba(255, 255, 255, 0.2); color: white; }
    </style>
</head>
<body>
    <section class="section">
        <div class="container">
            <div class="card">
                <div class="pastel-header">
                    <h1 class="title is-5 has-text-white">üìã ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å Kit ‡∏ó‡∏î‡πÅ‡∏ó‡∏ô</h1>
                </div>
                <div class="card-content">
                    <div class="field">
                        <label class="label">‡∏£‡∏´‡∏±‡∏™ Kit ID ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ (‡πÄ‡∏•‡∏Ç 3 ‡∏´‡∏•‡∏±‡∏Å)</label>
                        <div class="field has-addons">
                            <div class="control"><span class="input-prefix">EX-</span></div>
                            <div class="control is-expanded">
                                <input class="input input-main" type="number" id="kitNum" placeholder="‡πÄ‡∏ä‡πà‡∏ô 001" oninput="checkKitID(this.value)">
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                        <div class="control">
                            <input class="input" type="text" id="wardName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Kit ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏≠‡∏£‡πå‡∏î..." readonly onclick="this.readOnly=false">
                        </div>
                    </div>

                    <hr>

                    <div class="field" style="position: relative;">
                        <label class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î Extravasation</label>
                        <div class="control">
                            <input class="input" type="text" id="drugInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤..." oninput="smartSearchDrug(this.value)">
                        </div>
                        <div id="drugResults" class="drug-results"></div>
                    </div>

                    <div class="field">
                        <label class="label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏≤</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select id="position">
                                    <option value="‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠">‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠ (Dorsum of hand)</option>
                                    <option value="‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠">‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠ (Wrist)</option>
                                    <option value="‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Ç‡∏ô">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Ç‡∏ô (Forearm)</option>
                                    <option value="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (Grade)</label>
                        <div class="grade-container">
                            <div class="grade-item" onclick="setGrade(0)" id="g0"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 0: No symptoms</span><span class="grade-badge">0</span></div>
                            <div class="grade-item" onclick="setGrade(1)" id="g1"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 1: Mild symptoms</span><span class="grade-badge">1</span></div>
                            <div class="grade-item" onclick="setGrade(2)" id="g2"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 2: Moderate symptoms</span><span class="grade-badge">2</span></div>
                            <div class="grade-item" onclick="setGrade(3)" id="g3"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 3: Severe symptoms</span><span class="grade-badge">3</span></div>
                            <div class="grade-item" onclick="setGrade(4)" id="g4"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 4: Life-threatening</span><span class="grade-badge">4</span></div>
                        </div>
                        <input type="hidden" id="grade" value="">
                    </div>

                    <button class="button is-primary is-fullwidth is-large mt-5" onclick="submitReplacement()">
                        üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å Kit
                    </button>
                </div>
            </div>
        </div>
    </section>

    <script>
        const drugMaster = ["Arsenic trioxide", "Bortezomib", "Cyclophosphamide", "Doxorubicin", "Fluorouracil", "Oxaliplatin", "Paclitaxel", "Vincristine"];

        async function init() {
            try {
                // üö© ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                await liff.init({ liffId: "‡πÉ‡∏™‡πà_LIFF_ID_‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" }); 
                if (!liff.isLoggedIn()) liff.login();
            } catch (err) { console.error("LIFF Init Error", err); }
        }
        init();

        function checkKitID(val) {
            if (val.length === 3) {
                document.getElementById('wardName').value = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..."; // ‡∏à‡∏≥‡∏•‡∏≠‡∏á
                setTimeout(() => { document.getElementById('wardName').value = "‡∏†‡∏π‡∏°‡∏¥‡∏™‡∏¥‡∏£‡∏¥ 19C"; }, 500);
            }
        }

        function smartSearchDrug(val) {
            const resDiv = document.getElementById('drugResults');
            if (val.length >= 2) {
                const filtered = drugMaster.filter(d => d.toLowerCase().includes(val.toLowerCase()));
                resDiv.innerHTML = filtered.map(d => `<div class="drug-item" onclick="selectDrug('${d}')">${d}</div>`).join('');
                resDiv.style.display = filtered.length ? 'block' : 'none';
            } else { resDiv.style.display = 'none'; }
        }

        function selectDrug(name) {
            document.getElementById('drugInput').value = name;
            document.getElementById('drugResults').style.display = 'none';
        }

        function setGrade(g) {
            document.getElementById('grade').value = g;
            document.querySelectorAll('.grade-item').forEach(item => item.classList.remove('active'));
            document.getElementById('g' + g).classList.add('active');
        }

        async function submitReplacement() {
            const kitNum = document.getElementById('kitNum').value;
            const ward = document.getElementById('wardName').value;
            const drug = document.getElementById('drugInput').value;
            const pos = document.getElementById('position').value;
            const grade = document.getElementById('grade').value; // ‚ú® ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö ID

            if (!kitNum || !drug || grade === "") {
                alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            try {
                const msg = `REQ_REPLACEMENT|EX-${kitNum}|${ward}|${drug}|${pos}|${grade}`;
                await liff.sendMessages([{ "type": "text", "text": msg }]);
                liff.closeWindow();
            } catch (err) {
                alert("‚ùå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message + "\n‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå chat_message.write ‡πÉ‡∏ô LINE Developers ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á");
            }
        }
    </script>
</body>
</html>
