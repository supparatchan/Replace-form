<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡πÄ‡∏ö‡∏¥‡∏Å Kit ‡∏ó‡∏î‡πÅ‡∏ó‡∏ô</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500&display=swap" rel="stylesheet">

<style>
body { background:#F0F4F3; font-family:'Kanit',sans-serif; }
.card { border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,.1); }
.header { background:#015958; color:white; padding:16px; border-radius:16px 16px 0 0; text-align:center; }
.grade-box { border:2px solid #ddd; padding:12px; border-radius:12px; cursor:pointer; }
.grade-box.active { background:#015958; color:white; border-color:#015958; }
.drug-results { border:1px solid #ddd; max-height:160px; overflow-y:auto; display:none; background:white; position:absolute; width:100%; z-index:10; }
.drug-item { padding:8px; cursor:pointer; }
.drug-item:hover { background:#f1f1f1; }
</style>
</head>

<body>
<section class="section">
<div class="container">
<div class="card">

<div class="header">
<h4 class="title is-5 has-text-white">üìã ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å Kit ‡∏ó‡∏î‡πÅ‡∏ó‡∏ô</h4>
</div>

<div class="card-content">

<!-- Kit ID -->
<div class="field">
<label class="label">‡∏£‡∏´‡∏±‡∏™ Kit ID (3 ‡∏´‡∏•‡∏±‡∏Å)</label>
<input class="input" id="kitNum"
       type="text"
       inputmode="numeric"
       maxlength="3"
       placeholder="‡πÄ‡∏ä‡πà‡∏ô 015"
       oninput="onKitChange(this.value)"
       onblur="onKitBlur()">
<p class="help" id="kitHelp">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏ö 3 ‡∏´‡∏•‡∏±‡∏Å</p>
</div>

<!-- Ward -->
<div class="field">
<label class="label">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
<input class="input" id="wardName" readonly>
</div>

<hr>

<!-- Drug -->
<div class="field" style="position:relative;">
<label class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</label>
<input class="input" id="drugInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ"
       oninput="smartSearchDrug(this.value)">
<div id="drugResults" class="drug-results"></div>
</div>

<!-- Position -->
<div class="field">
<label class="label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏≤</label>
<div class="select is-fullwidth">
<select id="position">
<option value="‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠">‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠</option>
<option value="‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠">‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠</option>
<option value="‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Ç‡∏ô">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Ç‡∏ô</option>
<option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
</select>
</div>
</div>

<!-- Grade -->
<div class="field">
<label class="label">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</label>
<div class="columns is-multiline">

<div class="column is-6">
<div class="grade-box" onclick="setGrade(1)" id="g1">
<b>Grade 1</b><br>
‡πÅ‡∏î‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ / ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏∏‡∏û‡∏≠‡∏á
</div>
</div>

<div class="column is-6">
<div class="grade-box" onclick="setGrade(2)" id="g2">
<b>Grade 2</b><br>
‡∏ö‡∏ß‡∏°‡∏õ‡∏ß‡∏î / ‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏ï‡∏∂‡∏á
</div>
</div>

<div class="column is-6">
<div class="grade-box" onclick="setGrade(3)" id="g3">
<b>Grade 3</b><br>
‡∏û‡∏∏‡∏û‡∏≠‡∏á / ‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢
</div>
</div>

<div class="column is-6">
<div class="grade-box" onclick="setGrade(4)" id="g4">
<b>Grade 4</b><br>
‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ï‡∏≤‡∏¢ / ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î
</div>
</div>

</div>
<input type="hidden" id="grade">
</div>

<button class="button is-primary is-fullwidth" onclick="submitReplacement()">
üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠
</button>

</div>
</div>
</div>
</section>

<script>

const LIFF_ID = "2009181600-gwOEGw9p";
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxiR4ELkbirrkVy_48Aa217LIoKTDQWLJfbJm0OqnorPD3G_eV6bN-QpkwHDAIVv2t_/exec";

let kitInventory = [];
let selectedDrug = "";

async function init() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();
  const res = await fetch(GAS_API_URL);
  kitInventory = await res.json();
}
init();

/* -----------------------
   Kit ID Logic (Fixed)
------------------------ */

function normalizeDigits(v){
  return String(v||"").replace(/\D/g,"").slice(0,3);
}

function onKitChange(val){
  const digits = normalizeDigits(val);
  const input = document.getElementById("kitNum");
  input.value = digits;

  if(digits.length===3){
    lookupWard(digits);
  } else {
    document.getElementById("wardName").value="";
  }
}

function onKitBlur(){
  const input=document.getElementById("kitNum");
  const digits=normalizeDigits(input.value);

  if(digits.length>0 && digits.length<3){
    const padded=digits.padStart(3,"0");
    input.value=padded;
    lookupWard(padded);
  }
}

function lookupWard(digits){
  const fullId="EX-"+digits;
  const match=kitInventory.find(k=>k.kitId===fullId);
  const wardInput=document.getElementById("wardName");

  if(match && match.ward){
    wardInput.value=match.ward;
    wardInput.readOnly=true;
  } else {
    wardInput.value="";
    wardInput.readOnly=false;
    wardInput.placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏≠‡∏£‡πå‡∏î";
  }
}

/* -----------------------
   Drug Search
------------------------ */

const drugList = [
"Vinblastine","Vinorelbine","Oxaliplatin","Doxorubicin",
"Paclitaxel","Cisplatin","Carboplatin","Methotrexate",
"Irinotecan","Gemcitabine","Cyclophosphamide"
];

function smartSearchDrug(val){
  const search=val.toLowerCase();
  const box=document.getElementById("drugResults");
  if(search.length<3){ box.style.display="none"; return; }

  const results=drugList.filter(d=>d.toLowerCase().includes(search));
  box.innerHTML=results.map(d=>`<div class="drug-item" onclick="selectDrug('${d}')">${d}</div>`).join("");
  box.style.display=results.length?"block":"none";
}

function selectDrug(name){
  selectedDrug=name;
  document.getElementById("drugInput").value=name;
  document.getElementById("drugResults").style.display="none";
}

/* -----------------------
   Grade
------------------------ */

function setGrade(g){
  document.getElementById("grade").value=g;
  document.querySelectorAll(".grade-box").forEach(b=>b.classList.remove("active"));
  document.getElementById("g"+g).classList.add("active");
}

/* -----------------------
   Submit
------------------------ */

async function submitReplacement(){

  const kit="EX-"+document.getElementById("kitNum").value;
  const ward=document.getElementById("wardName").value;
  const drug=document.getElementById("drugInput").value;
  const pos=document.getElementById("position").value;
  const grade=document.getElementById("grade").value;

  if(!kit || !ward || !drug || !grade){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
    return;
  }

  const msg=`REQ_REPLACEMENT|${kit}|${ward}|${drug}|${pos}|${grade}`;
  await liff.sendMessages([{type:"text",text:msg}]);
  liff.closeWindow();
}

</script>
</body>
</html>
