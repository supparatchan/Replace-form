<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡πÄ‡∏ö‡∏¥‡∏Å Kit ‡∏ó‡∏î‡πÅ‡∏ó‡∏ô - ChemoKit</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500&display=swap" rel="stylesheet">
<style>
body { background:#F0F4F3; font-family:'Kanit',sans-serif;}
.card { border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
.header { background:#015958;color:white;border-radius:15px 15px 0 0;padding:15px;text-align:center;}
.drug-results{border:1px solid #ddd;border-top:none;max-height:150px;overflow-y:auto;display:none;background:white;position:absolute;width:100%;z-index:10;}
.drug-item{padding:10px;cursor:pointer;border-bottom:1px solid #eee;}
.drug-item:hover{background:#f5f5f5;}
.grade-item{border:2px solid #ddd;border-radius:12px;padding:10px;cursor:pointer;margin-bottom:6px;}
.grade-item.active{background:#015958;color:white;border-color:#015958;}
</style>
</head>
<body>
<section class="section">
<div class="container">
<div class="card">
<div class="header">
<h1 class="title is-5 has-text-white">üìã ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å Kit ‡∏ó‡∏î‡πÅ‡∏ó‡∏ô</h1>
</div>
<div class="card-content">

<div class="field">
<label class="label">‡∏£‡∏´‡∏±‡∏™ Kit ID (‡πÄ‡∏•‡∏Ç 3 ‡∏´‡∏•‡∏±‡∏Å)</label>
<input class="input" type="number" id="kitNum" placeholder="‡πÄ‡∏ä‡πà‡∏ô 001" oninput="checkKitID(this.value)">
</div>

<div class="field">
<label class="label">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
<input class="input" id="wardName" readonly>
<p class="help is-info" id="wardStatus">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏≠‡∏£‡πå‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
</div>

<hr>

<div class="field" style="position:relative;">
<label class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</label>
<input class="input" id="drugInput" oninput="smartSearchDrug(this.value)">
<div id="drugResults" class="drug-results"></div>
</div>

<div class="field">
<label class="label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏≤</label>
<select class="input" id="position">
<option value="‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠">‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠</option>
<option value="‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠">‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠</option>
<option value="‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Ç‡∏ô">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Ç‡∏ô</option>
<option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
</select>
</div>

<div class="field">
<label class="label">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</label>
<div id="grades"></div>
<input type="hidden" id="grade">
</div>

<button class="button is-primary is-fullwidth" id="submitBtn" onclick="submitReplacement()">üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>

</div>
</div>
</div>
</section>

<script>
const LIFF_ID = "2009181600-gwOEGw9p";
const GAS_API_URL = "YOUR_GAS_WEBAPP_URL"; // <-- ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

let kitInventory = [];

async function init() {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) liff.login();
    try {
        const res = await fetch(`${https://script.google.com/macros/s/AKfycbxiR4ELkbirrkVy_48Aa217LIoKTDQWLJfbJm0OqnorPD3G_eV6bN-QpkwHDAIVv2t_/exec}?action=getInventory`);
        kitInventory = await res.json();
    } catch(e){
        console.error("Inventory fetch error",e);
    }
}
init();

function checkKitID(val){
    if(val.length!==3) return;
    const padded = val.padStart(3,'0');
    const fullId = "EX-"+padded;
    const match = kitInventory.find(k=>k.kitId===fullId);
    if(match){
        wardName.value = match.ward || "";
        wardStatus.innerText = match.ward ? "‚úÖ ‡∏û‡∏ö‡∏ß‡∏≠‡∏£‡πå‡∏î" : "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏≠‡∏£‡πå‡∏î";
    }else{
        wardName.value="";
        wardStatus.innerText="‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö";
    }
}

const drugList=["Doxorubicin","Vinblastine","Paclitaxel","Cisplatin"];
function smartSearchDrug(val){
    if(val.length<2){drugResults.style.display="none";return;}
    const list=drugList.filter(d=>d.toLowerCase().includes(val.toLowerCase()));
    drugResults.innerHTML=list.map(d=>`<div class="drug-item" onclick="selectDrug('${d}')">${d}</div>`).join('');
    drugResults.style.display=list.length?'block':'none';
}
function selectDrug(name){
    drugInput.value=name;
    drugResults.style.display="none";
}

const gradeContainer=document.getElementById("grades");
for(let i=0;i<=4;i++){
    gradeContainer.innerHTML+=`<div class="grade-item" onclick="setGrade(${i})" id="g${i}">Grade ${i}</div>`;
}
function setGrade(g){
    grade.value=g;
    document.querySelectorAll(".grade-item").forEach(el=>el.classList.remove("active"));
    document.getElementById("g"+g).classList.add("active");
}

async function submitReplacement(){
    const btn=submitBtn;
    const raw=kitNum.value;
    if(!raw||raw.length<1||!drugInput.value||grade.value===""){
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        return;
    }
    const padded=raw.padStart(3,'0');
    const nonce=Date.now();
    const msg=`REQ_REPLACEMENT|EX-${padded}|${wardName.value}|${drugInput.value}|${position.value}|${grade.value}|${nonce}`;

    btn.disabled=true;
    btn.classList.add("is-loading");

    try{
        await liff.sendMessages([{type:"text",text:msg}]);
        liff.closeWindow();
    }catch(e){
        alert("Error: "+e.message);
        btn.disabled=false;
        btn.classList.remove("is-loading");
    }
}
</script>
</body>
</html>
