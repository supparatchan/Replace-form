<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏ö‡∏¥‡∏Å Kit ‡∏ó‡∏î‡πÅ‡∏ó‡∏ô - PharmaKit</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500&display=swap" rel="stylesheet">
    <style>
        body { background-color: #F0F4F3; font-family: 'Kanit', sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: none; }
        .pastel-header { background-color: #015958; color: white; border-radius: 15px 15px 0 0; padding: 15px; text-align: center; }
        .label { color: #4A4A4A; font-weight: 500; }
        .button.is-primary { background-color: #015958; color: #ffffff; border: none; font-weight: bold; }
        .button.is-primary:hover { background-color: #014140; }
        .input-prefix { background-color: #E0E0E0; border-radius: 8px 0 0 8px; padding: 7px 15px; font-weight: bold; display: flex; align-items: center; }
        .input-main { border-radius: 0 8px 8px 0 !important; }
        .drug-results { border: 1px solid #ddd; border-top: none; max-height: 150px; overflow-y: auto; display: none; background: white; position: absolute; width: 100%; z-index: 10; }
        .drug-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .drug-item:hover { background-color: #F5F5F5; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå Grade Cards */
        .grade-container { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .grade-item { background-color: #ffffff; border: 2px solid #E0E0E0; border-radius: 12px; padding: 12px 20px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #666; }
        .grade-item.active { background-color: #015958 !important; color: #ffffff !important; border-color: #015958; transform: scale(1.02); }
        .grade-badge { background-color: #f0f0f0; border-radius: 50%; width: 28px; height: 28px; display: flex; justify-content: center; align-items: center; font-size: 0.8rem; color: #333; }
        .active .grade-badge { background-color: rgba(255, 255, 255, 0.2); color: white; }
    </style>
</head>
<body>
    <section class="section">
        <div class="container">
            <div class="card">
                <div class="pastel-header">
                    <h1 class="title is-5 has-text-white">üìã ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å Kit ‡∏ó‡∏î‡πÅ‡∏ó‡∏ô</h1>
                </div>
                <div class="card-content">
                    <div class="field">
                        <label class="label">‡∏£‡∏´‡∏±‡∏™ Kit ID ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ (‡πÄ‡∏•‡∏Ç 3 ‡∏´‡∏•‡∏±‡∏Å)</label>
                        <div class="field has-addons">
                            <div class="control"><span class="input-prefix">EX-</span></div>
                            <div class="control is-expanded">
                                <input class="input input-main" type="number" id="kitNum" placeholder="‡πÄ‡∏ä‡πà‡∏ô 001" oninput="checkKitID(this.value)">
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                        <div class="control">
                            <input class="input" type="text" id="wardName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Kit ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏≠‡∏£‡πå‡∏î..." readonly onclick="this.readOnly=false">
                        </div>
                    </div>

                    <hr>

                    <div class="field" style="position: relative;">
                        <label class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î Extravasation</label>
                        <div class="control">
                            <input class="input" type="text" id="drugInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤..." oninput="smartSearchDrug(this.value)">
                        </div>
                        <div id="drugResults" class="drug-results"></div>
                    </div>

                    <div class="field">
                        <label class="label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏≤</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select id="position">
                                    <option value="‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠">‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠ (Dorsum of hand)</option>
                                    <option value="‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠">‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠ (Wrist)</option>
                                    <option value="‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Ç‡∏ô">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Ç‡∏ô (Forearm)</option>
                                    <option value="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (Grade)</label>
                        <div class="grade-container">
                            <div class="grade-item" onclick="setGrade(0)" id="g0"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 0: No symptoms</span><span class="grade-badge">0</span></div>
                            <div class="grade-item" onclick="setGrade(1)" id="g1"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 1: Mild symptoms</span><span class="grade-badge">1</span></div>
                            <div class="grade-item" onclick="setGrade(2)" id="g2"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 2: Moderate symptoms</span><span class="grade-badge">2</span></div>
                            <div class="grade-item" onclick="setGrade(3)" id="g3"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 3: Severe symptoms</span><span class="grade-badge">3</span></div>
                            <div class="grade-item" onclick="setGrade(4)" id="g4"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 4: Life-threatening</span><span class="grade-badge">4</span></div>
                        </div>
                        <input type="hidden" id="grade" value="">
                    </div>

                    <button class="button is-primary is-fullwidth is-large mt-5" onclick="submitReplacement()">
                        üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å Kit
                    </button>
                </div>
            </div>
        </div>
    </section>

    <script>
     //
const drugList = [
    { name: "Vinblastine", keys: "vbl velbe" }, { name: "Vinorelbine", keys: "vnr navelbine" },
    { name: "Oxaliplatin", keys: "oxa eloxatin" }, { name: "Carmustine", keys: "bcnu bicnu" },
    { name: "Docetaxel", keys: "taxotere" }, { name: "Paclitaxel", keys: "tax taxol" },
    { name: "Dactinomycin", keys: "actd cosmegen" }, { name: "Doxorubicin", keys: "adr adriamycin" },
    { name: "Idarubicin", keys: "ida idamycin" }, { name: "Mitomycin", keys: "mmc mitomycin-c" },
    { name: "Mitoxantrone", keys: "novantrone" }, { name: "Bendamustine", keys: "treanda" },
    { name: "Bleomycin", keys: "bleo" }, { name: "Busulfan", keys: "myleran" },
    { name: "Carboplatin", keys: "cbdca" }, { name: "Carfilzomib", keys: "kyprolis" },
    { name: "Cisplatin", keys: "cddp" }, { name: "Cyclophosphamide", keys: "ctx cyc" },
    { name: "Dacarbazine", keys: "dtic" }, { name: "Etoposide", keys: "vp-16" },
    { name: "Fluorouracil", keys: "5fu 5-fu" }, { name: "Gemcitabine", keys: "gemzar" },
    { name: "Ifosfamide", keys: "ifo" }, { name: "Irinotecan", keys: "cpt-11 camptosar" },
    { name: "Melphalan", keys: "alkeran" }, { name: "Topotecan", keys: "hycamtin" },
    { name: "Cytarabine", keys: "ara-c" }, { name: "Fludarabine", keys: "fludara" },
    { name: "Methotrexate", keys: "mtx" }, { name: "Pemetrexed", keys: "alimta" },
    { name: "Asparaginase", keys: "elspar" }, { name: "Bortezomib", keys: "btz velcade" },
    { name: "Arsenic trioxide", keys: "ato" }, { name: "Cabazitaxel", keys: "jevtana" }
];

// üö© ‡πÉ‡∏™‡πà Web App URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å GAS ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyCE7cYQuZaOWBd_Pd36nEid2Zts259j-8r-cPtbX3EtbofLuZjmK4JaG8BQjYyJTdg/exec"; 
let kitInventory = [];

async function init() {
    try {
        await liff.init({ liffId: "2009181600-gwOEGw9p" }); 
        if (!liff.isLoggedIn()) liff.login();
        
        // üöÄ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏≠‡∏£‡πå‡∏î‡∏à‡∏≤‡∏Å GAS ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ
        const response = await fetch(`${GAS_API_URL}?action=getInventory`);
        kitInventory = await response.json();
        console.log("Inventory Loaded:", kitInventory.length, "kits");
        
    } catch (err) { console.error("LIFF/Fetch Error", err); }
}
init();

// üîç ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏≠‡∏£‡πå‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
function checkKitID(val) {
    const wardInput = document.getElementById('wardName');
    
    if (val.length === 3) {
        const fullId = "EX-" + val;
        wardInput.value = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
        
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å GAS
        const match = kitInventory.find(item => item.kitId === fullId);
        
        if (match) {
            wardInput.value = match.ward;
        } else {
            wardInput.value = "";
            wardInput.placeholder = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™ Kit ‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á...";
            wardInput.readOnly = false; // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
        }
    }
}

        function checkKitID(val) {
            if (val.length === 3) {
                document.getElementById('wardName').value = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..."; // ‡∏à‡∏≥‡∏•‡∏≠‡∏á
                setTimeout(() => { document.getElementById('wardName').value = "‡∏†‡∏π‡∏°‡∏¥‡∏™‡∏¥‡∏£‡∏¥ 19C"; }, 500);
            }
        }

        function smartSearchDrug(val) {
            const resDiv = document.getElementById('drugResults');
            const searchVal = val.toLowerCase().trim();

            if (searchVal.length >= 3) { // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ
            const filtered = drugList.filter(item => 
            item.name.toLowerCase().includes(searchVal) || 
            item.keys.toLowerCase().includes(searchVal)
        );

        resDiv.innerHTML = filtered.map(item => `
            <div class="drug-item" onclick="selectDrug('${item.name}')" style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;">
                <div style="font-weight: bold; color: #015958;">${item.name}</div>
                <div style="font-size: 0.7rem; color: #888;">Keywords: ${item.keys}</div>
            </div>
        `).join('');
        resDiv.style.display = filtered.length ? 'block' : 'none';
    } else {
        resDiv.style.display = 'none';
    }
}
        function selectDrug(name) {
            document.getElementById('drugInput').value = name;
            document.getElementById('drugResults').style.display = 'none';
        }

        function setGrade(g) {
            document.getElementById('grade').value = g;
            document.querySelectorAll('.grade-item').forEach(item => item.classList.remove('active'));
            document.getElementById('g' + g).classList.add('active');
        }

        //
async function submitReplacement() {
    // 1. ‡∏î‡∏∂‡∏á Element ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥ Guard
    const submitBtn = document.querySelector('button.is-primary'); 
    const kitNum = document.getElementById('kitNum').value;
    const ward = document.getElementById('wardName').value;
    const drug = document.getElementById('drugInput').value;
    const pos = document.getElementById('position').value;
    const grade = document.getElementById('grade').value;

    // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° Guard
    if (!kitNum || !drug || grade === "") {
        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        return;
    }

    // üö© ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Guard (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥)
    if (submitBtn.disabled) return; // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠
    
    submitBtn.disabled = true; // ‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    submitBtn.classList.add('is-loading'); // ‡πÄ‡∏û‡∏¥‡πà‡∏° Loading Spinner (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ Bulma)
    submitBtn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."; 

    try {
        // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå 02_Flow_Nurse.gs ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        const msg = `REQ_REPLACEMENT|EX-${kitNum}|${ward}|${drug}|${pos}|${grade}`;
        
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó
        await liff.sendMessages([{ "type": "text", "text": msg }]); 
        
        // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        liff.closeWindow();
        
    } catch (err) {
        // üö© ‡∏Ñ‡∏•‡∏≤‡∏¢‡∏•‡πá‡∏≠‡∏Å Guard ‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
        submitBtn.disabled = false;
        submitBtn.classList.remove('is-loading');
        submitBtn.innerText = "üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å Kit";
        
        console.error("LIFF Send Error:", err);
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: " + err.message);
    }
}
</script>
</body>
</html>
